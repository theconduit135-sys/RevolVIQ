module.exports=[78718,e=>{"use strict";var t=e.i(98323),r=e.i(14629),n=e.i(79145),a=e.i(73983),s=e.i(46786),o=e.i(6461),i=e.i(89434),l=e.i(38262),c=e.i(22009);function u(e,t,r){let n=r?new d:p;if(!(e.root&&h(e.root,n,t))&&e.queryPlan&&function e(t,r,n){return!!t&&(t.fetch?.trace?.root&&t.fetch.serviceName?h(t.fetch.trace.root,r.child(`service:${t.fetch.serviceName}`),n):t.flatten?.node?e(t.flatten.node,r,n):t.parallel?.nodes?t.parallel.nodes.some(t=>e(t,r,n)):!!t.sequence?.nodes&&t.sequence.nodes.some(t=>e(t,r,n)))}(e.queryPlan,n,t))return}function h(e,t,r){return!!r(e,t)||(e.child?.some(e=>{let n=e.responseName?t.child(e.responseName):t;return h(e,n,r)})??!1)}let p={toArray(){throw Error("not collecting paths!")},child(){return this}};class d{toArray(){return[]}child(e){return new y(e,this)}}class y{responseName;prev;constructor(e,t){this.responseName=e,this.prev=t}toArray(){let e=[],t=this;for(;t instanceof y;)e.push(t.responseName),t=t.prev;return e.reverse()}child(e){return new y(e,this)}}class g{buckets;static BUCKET_COUNT=384;static EXPONENT_LOG=Math.log(1.1);toArray(){let e=0,t=[];for(let r of this.buckets)0===r?e++:(1===e?t.push(0):0!==e&&t.push(-e),t.push(Math.floor(r)),e=0);return t}static durationToBucket(e){let t=Math.ceil(Math.log(e/1e3)/g.EXPONENT_LOG);return t<=0||Number.isNaN(t)?0:t>=g.BUCKET_COUNT?g.BUCKET_COUNT-1:t}incrementDuration(e,t=1){return this.incrementBucket(g.durationToBucket(e),t),this}incrementBucket(e,t=1){if(e>=g.BUCKET_COUNT)throw Error("Bucket is out of bounds of the buckets array");if(e>=this.buckets.length){let t=this.buckets.length;this.buckets.length=e+1,this.buckets.fill(0,t)}this.buckets[e]+=t}combine(e){for(let t=0;t<e.buckets.length;t++)this.incrementBucket(t,e.buckets[t])}constructor(e){const t=e?.initSize||74,r=e?.buckets,n=Math.max(r?.length||0,t);this.buckets=Array(n).fill(0),r&&r.forEach((e,t)=>this.buckets[t]=e)}}class f{bytes=0}class m{header;tracesPreAggregated=!1;constructor(e){this.header=e}tracesPerQuery=Object.create(null);endTime=null;operationCount=0;sizeEstimator=new f;ensureCountsAreIntegers(){for(let e of Object.values(this.tracesPerQuery))e.ensureCountsAreIntegers()}addTrace({statsReportKey:e,trace:r,asTrace:n,referencedFieldsByType:a,maxTraceBytes:s=0xa00000,nonFtv1ErrorPaths:o}){let i=this.getTracesAndStats({statsReportKey:e,referencedFieldsByType:a});if(n){let e=t.Trace.encode(r).finish();!isNaN(s)&&e.length>s?i.statsWithContext.addTrace(r,this.sizeEstimator,o):(i.trace.push(e),this.sizeEstimator.bytes+=2+e.length)}else i.statsWithContext.addTrace(r,this.sizeEstimator,o)}getTracesAndStats({statsReportKey:e,referencedFieldsByType:t}){let r=this.tracesPerQuery[e];if(r)return r;for(let[r,n]of(this.sizeEstimator.bytes+=N(e),Object.entries(t)))for(let e of(this.sizeEstimator.bytes+=4,n.isInterface&&(this.sizeEstimator.bytes+=2),this.sizeEstimator.bytes+=N(r),n.fieldNames))this.sizeEstimator.bytes+=N(e);return this.tracesPerQuery[e]=new T(t)}}class T{referencedFieldsByType;constructor(e){this.referencedFieldsByType=e}trace=[];statsWithContext=new b;internalTracesContributingToStats=[];ensureCountsAreIntegers(){this.statsWithContext.ensureCountsAreIntegers()}}class b{map=Object.create(null);toArray(){return Object.values(this.map)}ensureCountsAreIntegers(){for(let e of Object.values(this.map))e.ensureCountsAreIntegers()}addTrace(e,t,r){this.getContextualizedStats(e,t).addTrace(e,t,r)}getContextualizedStats(e,t){let r={clientName:e.clientName,clientVersion:e.clientVersion},n=JSON.stringify(r),a=this.map[n];if(a)return a;t.bytes+=20+N(e.clientName)+N(e.clientVersion);let s=new C(r);return this.map[n]=s,s}}class C{context;queryLatencyStats=new S;perTypeStat=Object.create(null);constructor(e){this.context=e}ensureCountsAreIntegers(){for(let e of Object.values(this.perTypeStat))e.ensureCountsAreIntegers()}addTrace(e,r,n=[]){let{fieldExecutionWeight:a}=e;if(!a&&this.queryLatencyStats.requestsWithoutFieldInstrumentation++,this.queryLatencyStats.requestCount++,e.fullQueryCacheHit?(this.queryLatencyStats.cacheLatencyCount.incrementDuration(e.durationNs),this.queryLatencyStats.cacheHits++):this.queryLatencyStats.latencyCount.incrementDuration(e.durationNs),!e.fullQueryCacheHit&&e.cachePolicy?.maxAgeNs!=null)switch(e.cachePolicy.scope){case t.Trace.CachePolicy.Scope.PRIVATE:this.queryLatencyStats.privateCacheTtlCount.incrementDuration(e.cachePolicy.maxAgeNs);break;case t.Trace.CachePolicy.Scope.PUBLIC:this.queryLatencyStats.publicCacheTtlCount.incrementDuration(e.cachePolicy.maxAgeNs)}e.persistedQueryHit&&this.queryLatencyStats.persistedQueryHits++,e.persistedQueryRegister&&this.queryLatencyStats.persistedQueryMisses++,e.forbiddenOperation&&this.queryLatencyStats.forbiddenOperationCount++,e.registeredOperation&&this.queryLatencyStats.registeredOperationCount++;let s=!1,o=new Set;for(let{subgraph:t,path:i}of(u(e,(e,t)=>{if(e.error?.length){s=!0;let n=this.queryLatencyStats.rootErrorStats;t.toArray().forEach(e=>{n=n.getChild(e,r)}),o.add(n),n.errorsCount+=e.error.length}if(a){let t=e.originalFieldName||e.responseName;if(e.parentType&&t&&e.type&&null!=e.endTime&&null!=e.startTime&&e.endTime>=e.startTime){let n=this.getTypeStat(e.parentType,r).getFieldStat(t,e.type,r);n.errorsCount+=e.error?.length??0,n.observedExecutionCount++,n.estimatedExecutionCount+=a,n.requestsWithErrorsCount+=+((e.error?.length??0)>0),n.latencyCount.incrementDuration(e.endTime-e.startTime,a)}}return!1},!0),n))if(s=!0,i){let e=this.queryLatencyStats.rootErrorStats.getChild(`service:${t}`,r);i.forEach(t=>{"string"==typeof t&&(e=e.getChild(t,r))}),o.add(e),e.errorsCount+=1}for(let e of o)e.requestsWithErrorsCount+=1;s&&this.queryLatencyStats.requestsWithErrorsCount++}getTypeStat(e,t){let r=this.perTypeStat[e];if(r)return r;t.bytes+=N(e);let n=new w;return this.perTypeStat[e]=n,n}}class S{latencyCount=new g;requestCount=0;requestsWithoutFieldInstrumentation=0;cacheHits=0;persistedQueryHits=0;persistedQueryMisses=0;cacheLatencyCount=new g;rootErrorStats=new v;requestsWithErrorsCount=0;publicCacheTtlCount=new g;privateCacheTtlCount=new g;registeredOperationCount=0;forbiddenOperationCount=0}class v{children=Object.create(null);errorsCount=0;requestsWithErrorsCount=0;getChild(e,t){let r=this.children[e];if(r)return r;let n=new v;return this.children[e]=n,t.bytes+=N(e)+4,n}}class w{perFieldStat=Object.create(null);getFieldStat(e,t,r){let n=this.perFieldStat[e];if(n)return n;r.bytes+=N(e)+N(t)+10;let a=new E(t);return this.perFieldStat[e]=a,a}ensureCountsAreIntegers(){for(let e of Object.values(this.perFieldStat))e.ensureCountsAreIntegers()}}class E{returnType;errorsCount=0;observedExecutionCount=0;estimatedExecutionCount=0;requestsWithErrorsCount=0;latencyCount=new g;constructor(e){this.returnType=e}ensureCountsAreIntegers(){this.estimatedExecutionCount=Math.floor(this.estimatedExecutionCount)}}function N(e){return 2+Buffer.byteLength(e)}var P=e.i(84340),A=e.i(82564),O=e.i(48668);let q={hostname:s.default.hostname(),agentVersion:`@apollo/server@${P.packageVersion}`,runtimeVersion:`node ${process.version}`,uname:`${s.default.platform()}, ${s.default.type()}, ${s.default.release()}, ${s.default.arch()})`};function x(e=Object.create(null)){let s=e.fieldLevelInstrumentation,h="number"==typeof s?async()=>Math.random()<s?1/s:0:s||(async()=>!0),p=null;return(0,i.internalPlugin)({__internal_plugin_id__:"UsageReporting",__is_disabled_plugin__:!1,requestDidStart:async e=>p?p(e):{},async serverWillStart({logger:s,apollo:i,startedInBackground:d,schema:y}){let f,T,b,C=e.logger??s,{key:S,graphRef:v}=i;if(!(S&&v))throw Error("You've enabled usage reporting via ApolloServerPluginUsageReporting, but you also need to provide your Apollo API key and graph ref, via the APOLLO_KEY/APOLLO_GRAPH_REF environment variables or via `new ApolloServer({apollo: {key, graphRef})`.");if((0,O.schemaIsSubgraph)(y))if(e.__onlyIfSchemaIsNotSubgraph)return C.warn("You have specified an Apollo API key and graph ref but this server appears to be a subgraph. Typically usage reports are sent to Apollo by your Router or Gateway, not directly from your subgraph; usage reporting is disabled. To enable usage reporting anyway, explicitly install `ApolloServerPluginUsageReporting`. To disable this warning, install `ApolloServerPluginUsageReportingDisabled`."),{};else C.warn("You have installed `ApolloServerPluginUsageReporting` but this server appears to be a subgraph. Typically usage reports are sent to Apollo by your Router or Gateway, not directly from your subgraph. If this was unintentional, remove `ApolloServerPluginUsageReporting` from your server's `plugins` array.");C.info(`Apollo usage reporting starting! See your graph at https://studio.apollographql.com/graph/${encodeURI(v)}/`);let w=e.sendReportsImmediately??d,E=null,N=new Map,P=e=>{let r=N.get(e);if(r)return r;let n=new m(new t.ReportHeader({...q,executableSchemaId:e,graphRef:v}));return N.set(e,n),n},x=e.overrideReportedSchema?(0,A.computeCoreSchemaHash)(e.overrideReportedSchema):void 0;w||(T=setInterval(()=>U(),e.reportIntervalMs||1e4));let R=e.sendTraces??!0,I=e.experimental_sendOperationAsTrace??(b=new c.LRUCache({maxSize:1048576,sizeCalculation:(e,t)=>t&&Buffer.byteLength(t)||0}),(e,t)=>{let r,n=e.endTime?.seconds;if(null==n)throw Error("programming error: endTime not set on trace");let a=(r=!1,u(e,function(e){return(e.error?.length??0)>0&&(r=!0),r},!1),r),s=JSON.stringify([t,g.durationToBucket(e.durationNs),Math.floor(n/60),a?Math.floor(n/5):""]);return!b.get(s)&&(b.set(s,!0),!0)}),L=!1;function k(e){if(f?.executableSchema===e)return f.executableSchemaId;let t=(0,A.computeCoreSchemaHash)((0,a.printSchema)(e));return f={executableSchema:e,executableSchemaId:t},t}async function U(){await Promise.all([...N.keys()].map(e=>H(e)))}async function H(t){return _(t).catch(t=>{e.reportErrorFunction?e.reportErrorFunction(t):C.error(t.message)})}let _=async r=>{let a,s=(a=N.get(r))?(N.delete(r),a):null;if(!s||0===Object.keys(s.tracesPerQuery).length&&0===s.operationCount)return;s.endTime=(0,l.dateToProtoTimestamp)(new Date),s.ensureCountsAreIntegers();let i=t.Report.verify(s);if(i)throw Error(`Error verifying report: ${i}`);let c=t.Report.encode(s).finish();if(s=null,e.debugPrintReports){let e=t.Report.decode(c);C.info(`Apollo usage report: ${JSON.stringify(e.toJSON())}`)}let u=await new Promise((e,t)=>{(0,o.gzip)(c,(r,n)=>{r?t(r):e(n)})});c=null;let h=e.fetcher??fetch,p=await (0,n.default)(async()=>{let t=await h((e.endpointUrl||"https://usage-reporting.api.apollographql.com")+"/api/ingress/traces",{method:"POST",headers:{"user-agent":"ApolloServerPluginUsageReporting","x-api-key":S,"content-encoding":"gzip",accept:"application/json"},body:u,signal:AbortSignal.timeout(e.requestTimeoutMs??3e4)});if(!(t.status>=500)||!(t.status<600))return t;throw Error(`HTTP status ${t.status}, ${await t.text()||"(no body)"}`)},{retries:(e.maxAttempts||5)-1,minTimeout:e.minimumRetryDelayMs||100,factor:2}).catch(e=>{throw Error(`Error sending report to Apollo servers: ${e.message}`)});if(p.status<200||p.status>=300)throw Error(`Error sending report to Apollo servers: HTTP status ${p.status}, ${await p.text()||"(no body)"}`);if(R&&200===p.status&&p.headers.get("content-type")?.match(/^\s*application\/json\s*(?:;|$)/i)){let e,t=await p.text();try{e=JSON.parse(t)}catch(e){throw Error(`Error parsing response from Apollo servers: ${e}`)}!0===e.tracesIgnored&&(C.debug("This graph's organization does not have access to traces; sending all subsequent operations as stats."),R=!1)}e.debugPrintReports&&C.info(`Apollo usage report: status ${p.status}`)};return p=({metrics:n,schema:a,request:{http:s,variables:o}})=>{let i=new l.TraceTreeBuilder({maskedBy:"ApolloServerPluginUsageReporting",sendErrors:e.sendErrors});i.startTiming(),n.startHrTime=i.startHrTime;let u=!1,p=!1,d=null;async function y(t){if(null===d){if("function"!=typeof e.includeRequest){d=!0;return}"boolean"!=typeof(d=await e.includeRequest(t))&&(C.warn("The 'includeRequest' async predicate function must return a boolean value."),d=!0)}}s&&(i.trace.http=new t.Trace.HTTP({method:t.Trace.HTTP.Method[s.method]||t.Trace.HTTP.Method.UNKNOWN}),e.sendHeaders&&function(e,r,n){if(n&&(!("none"in n)||!n.none)&&(!("all"in n)||n.all)){for(let[a,s]of r)if(!("exceptNames"in n&&n.exceptNames.some(e=>e.toLowerCase()===a))&&(!("onlyNames"in n)||n.onlyNames.some(e=>e.toLowerCase()===a)))switch(a){case"authorization":case"cookie":case"set-cookie":break;default:e.requestHeaders[a]=new t.Trace.HTTP.Values({value:[s]})}}}(i.trace.http,s.headers,e.sendHeaders));let g=!1;return{async didResolveSource(r){var a,s;let l,c;g=!0,n.persistedQueryHit&&(i.trace.persistedQueryHit=!0),n.persistedQueryRegister&&(i.trace.persistedQueryRegister=!0),o&&(i.trace.details=(a=e.sendVariableValues,s=r.source,l=new t.Trace.Details,Object.keys(c=(()=>{if(!a||!("transform"in a))return o;{var e,t,r;let n=Object.keys(o);try{let r,i=a.transform({variables:o,operationString:s});return e=n,t=i,r=Object.create(null),e.forEach(e=>{r[e]=t[e]}),r}catch(t){let e;return r=n,e=Object.create(null),r.forEach(t=>{e[t]="[PREDICATE_FUNCTION_ERROR]"}),e}}})()).forEach(e=>{if(!a||"none"in a&&a.none||"all"in a&&!a.all||"exceptNames"in a&&a.exceptNames.includes(e)||"onlyNames"in a&&!a.onlyNames.includes(e))l.variablesJson[e]="";else try{l.variablesJson[e]=void 0===c[e]?"":JSON.stringify(c[e])}catch(t){l.variablesJson[e]=JSON.stringify("[Unable to convert value to JSON]")}}),l));let u=(e.generateClientInfo||function({request:e}){let t="apollographql-client-name",r="apollographql-client-version";return e.http?.headers?.get(t)||e.http?.headers?.get(r)?{clientName:e.http?.headers?.get(t),clientVersion:e.http?.headers?.get(r)}:e.extensions?.clientInfo?e.extensions.clientInfo:{}})(r);if(u){let{clientName:e,clientVersion:t}=u;i.trace.clientVersion=t||"",i.trace.clientName=e||""}},validationDidStart:async()=>async e=>{u=!!e&&0!==e.length},async didResolveOperation(e){if(p=void 0===e.operation,await y(e),d&&!p&&void 0===n.captureTraces){let t=await h(e);i.trace.fieldExecutionWeight="number"==typeof t?t:+!!t,n.captureTraces=!!i.trace.fieldExecutionWeight}},async executionDidStart(){if(n.captureTraces)return{willResolveField:({info:e})=>i.willResolveField(e)}},async didEncounterSubsequentErrors(e,t){i.didEncounterErrors(t)},async willSendSubsequentPayload(e,t){t.hasNext||await f(e)},async willSendResponse(e){g&&(e.errors&&i.didEncounterErrors(e.errors),"single"===e.response.body.kind&&await f(e))}};async function f(s){let o=!!s.operation;await y(s),i.stopTiming();let l=x??k(a);if(!1===d){o&&P(l).operationCount++;return}i.trace.fullQueryCacheHit=!!n.responseCacheHit,i.trace.forbiddenOperation=!!n.forbiddenOperation,i.trace.registeredOperation=!!n.registeredOperation;let h=s.overallCachePolicy.policyIfCacheable();async function g(){let l,h;if(L)return;await new Promise(e=>setImmediate(e));let d=x??k(a),{trace:y}=i;s.document?u?h=`## GraphQLValidationFailure
`:p&&(h=`## GraphQLUnknownOperationName
`):h=`## GraphQLParseFailure
`;let g=void 0===h;if(h)e.sendUnexecutableOperationDocuments&&(y.unexecutedOperationBody=s.source,y.unexecutedOperationName=s.request.operationName||""),l=Object.create(null);else{let t=function(){var t,n;if(!s.document)throw Error("No document?");let o=(t=s.queryHash,n=s.operationName||"",`${t}${n&&":"+n}`);E&&E.forSchema===a||(E={forSchema:a,cache:function({logger:e}){let t,r=0;return new c.LRUCache({sizeCalculation:e=>Buffer.byteLength(JSON.stringify(e),"utf8"),maxSize:0xa00000,dispose(){r++,(!t||new Date().getTime()-t.getTime()>6e4)&&(t=new Date,e.warn(`This server is processing a high number of unique operations.  A total of ${r} records have been ejected from the ApolloServerPluginUsageReporting signature cache in the past interval.  If you see this warning frequently, please open an issue on the Apollo Server repository.`),r=0)}})}({logger:C})});let i=E.cache.get(o);if(i)return i;let l={signature:(e.calculateSignature||r.usageReportingSignature)(s.document,s.operationName||""),referencedFieldsByType:(0,r.calculateReferencedFieldsByType)({document:s.document,schema:a,resolvedOperationName:s.operationName??null})};return E.cache.set(o,l),l}();h=`# ${s.operationName||"-"}
${t.signature}`,l=t.referencedFieldsByType}let f=t.Trace.verify(y);if(f)throw Error(`Error encoding trace: ${f}`);o&&P(d).operationCount++,P(d).addTrace({statsReportKey:h,trace:y,asTrace:R&&(!g||!!n.captureTraces)&&!n.nonFtv1ErrorPaths?.length&&I(y,h),referencedFieldsByType:l,nonFtv1ErrorPaths:n.nonFtv1ErrorPaths??[]}),(w||P(d).sizeEstimator.bytes>=(e.maxUncompressedReportSize||4194304))&&await H(d)}h&&(i.trace.cachePolicy=new t.Trace.CachePolicy({scope:"PRIVATE"===h.scope?t.Trace.CachePolicy.Scope.PRIVATE:"PUBLIC"===h.scope?t.Trace.CachePolicy.Scope.PUBLIC:t.Trace.CachePolicy.Scope.UNKNOWN,maxAgeNs:1e9*h.maxAge})),n.queryPlanTrace&&(i.trace.queryPlan=n.queryPlanTrace),g().catch(C.error.bind(C))}},{async serverWillStop(){T&&(clearInterval(T),T=void 0),L=!0,await U()}}}})}e.s([],40879),e.i(40879),e.s(["ApolloServerPluginUsageReporting",()=>x],78718)}];

//# sourceMappingURL=be510_%40apollo_server_dist_esm_plugin_usageReporting_index_7c745d5d.js.map